// Prisma Schema for Summa AI
// Database: PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Lecture {
  id        String   @id @default(uuid())
  title     String
  createdAt BigInt   // Unix timestamp in milliseconds

  sessions  Session[]

  @@map("lectures")
}

model Session {
  id        String   @id @default(uuid())
  lectureId String
  idx       Int      // Session index within lecture
  mode      String   // "manual" | "auto"
  status    String   @default("idle") // "idle" | "recording" | "uploaded" | "processing" | "completed" | "error"
  createdAt BigInt   // Unix timestamp in milliseconds

  // Policy fields (flattened for simplicity)
  policyLengthMin  Int     @default(55)
  policyOverlapSec Int     @default(5)
  policyVadPause   Boolean @default(true)

  lecture              Lecture               @relation(fields: [lectureId], references: [id], onDelete: Cascade)
  segments             Segment[]
  transcriptParagraphs TranscriptParagraph[]

  @@index([lectureId])
  @@map("sessions")
}

model Segment {
  id        String   @id @default(uuid())
  sessionId String
  localPath String?  // Optional path to uploaded audio file
  createdAt BigInt   // Unix timestamp in milliseconds

  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("segments")
}

model TranscriptParagraph {
  id        String   @id @default(uuid())
  sessionId String
  text      String   @db.Text
  startMs   Int
  endMs     Int
  createdAt BigInt   // Unix timestamp in milliseconds

  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("transcript_paragraphs")
}

model Alignment {
  id        String   @id @default(uuid())
  sessionId String
  paraId    String
  slidePage Int
  deckId    String
  score     Float
  createdAt BigInt   // Unix timestamp in milliseconds

  @@index([sessionId])
  @@index([paraId])
  @@map("alignments")
}

model Summary {
  id        String   @id @default(uuid())
  sessionId String   @unique
  deckId    String
  items     Json     // SummaryItem[] stored as JSON
  metrics   Json     // Metrics object stored as JSON
  createdAt BigInt   // Unix timestamp in milliseconds

  @@index([sessionId])
  @@map("summaries")
}

// ============================================================================
// CRITICAL FIX: Usage Tracking & Cost Control
// ============================================================================

model UsageMetrics {
  id        String  @id @default(uuid())
  lectureId String?
  sessionId String?

  // API usage tracking
  whisperMinutes  Float @default(0)
  gpt4Tokens      Int   @default(0)
  embeddingTokens Int   @default(0)

  // Cost tracking (in USD cents to avoid floating point issues)
  whisperCost     Int @default(0)
  gpt4Cost        Int @default(0)
  embeddingCost   Int @default(0)
  totalCost       Int @default(0)

  createdAt BigInt
  updatedAt BigInt

  @@index([lectureId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("usage_metrics")
}

model QuotaLimit {
  id     String  @id @default(uuid())
  userId String? @unique // Will be used when authentication is added

  // Monthly limits (default: free tier)
  maxMinutes Int @default(180) // 3 hours per month
  maxCost    Int @default(500) // $5.00 per month (in cents)

  // Current usage (resets monthly)
  usedMinutes Float @default(0)
  usedCost    Int   @default(0)

  // Metadata
  resetDate BigInt // Next reset timestamp
  createdAt BigInt
  updatedAt BigInt

  @@map("quota_limits")
}
